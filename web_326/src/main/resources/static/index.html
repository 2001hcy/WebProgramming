<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Comments</title>
    <script     src="http://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
</head>
<body>
<div>
    <div>
        <input id="inputUserId" placeholder="유저ID" style="width:200px;">
        <input id="inputContent" placeholder="내용" style="width: 200px">
        <button onclick="addComment()">등록</button>
    </div>
</div>
<div id="comments-list"></div>
<script>

    async function getCommentList() {
        try {
            let response = await $.get('/comment/list');
            $('#comments-list').html('');
            for (let i = 0; i < response.length; i++) {
                let comment = response[i];
                $('#comments-list').append(`
                    <div style="display: flex; border-bottom: 1px solid silver;">
                        <div style="width: 50px;">${comment.id}</div>
                        <div id="userId_${response.id}" style="width: 100px;">${comment.userId}</div>
                        <div style="width: 150px;">${comment.content}</div>
                        <div><button onclick="editComment(this,${response.id})">수정</button>
                        <button onclick="removeComment(this,${response.id})">삭제</button></div>
                    </div>
                `);
            }
        } catch (err) {
            $('#comments-list').html(JSON.stringify(err));
        }
    }
    async function addComment() {
        try {
            let newContent = {
                userId:$('#inputUserId').val().trim(),
                content:$('#inputContent').val().trim()
            };
            let response = await $.ajax({
                type:"POST",
                url:"/comment/add",
                contentType : "application/json",
                data: JSON.stringify(newContent),
            });
            $('#comments-list').append(`
                    <div id="comment_${response.id}" style="display: flex; border-bottom: 1px solid silver;">
                        <div style="width: 50px;">${response.id}</div>
                        <div id="userId_${response.id}" style="width: 100px;">${response.userId}</div>
                        <div style="width: 150px;">${response.content}</div>
                        <div><button onclick="editComment(this,${response.id})">수정</button>
                        <button onclick="removeComment(this,${response.id})">삭제</button></div>
                    </div>
                `);
        } catch (error) {

        }
    }
    async function removeComment(button,commentId){
        if ($(button).text() === '삭제') {
            try {
                let response = await $.ajax({
                    type:"DELETE",
                    url:"/comment/delete/"+commentId
                });
                $(`#comment_${commentId}`).remove();
            } catch (error) {
                alert(error);
            }
        }  else {
            $(button).text('삭제');
            $(button).prev().text('수정');
            $(`#comment_${commentId}`).find('div:nth-child(3)').html(content);
        }
    }
    let content = null;
    async function editComment(button, commentId){
        let comment = $(`#comment_${commentId}`);
        let tag = null;
        if ($(button).text() === '수정'){
            content = comment.find('div:nth-child(3)').html();
            tag = `<input id="content_${commentId}" value="${content}">`;
            comment.find('div:nth-child(3)').html(tag);
            $(button).text('확인');
            $(button).next().text("취소");
        } else {
            try {
                content = comment.find('div:nth-child(3)').html();
                content = $(`#content_${commentId}`).val();
                let userId = $(`#userId_${commentId}`).text();
                tag = `${content}`;
                comment.find('div:nth-child(3)').html(tag);
                let updateContent = {
                    userId:userId,
                    content:content
                };
                let response = await $.ajax({
                    type:"PUT",
                    url:"/comment/update/"+commentId,
                    contentType : "application/json",
                    data: JSON.stringify(updateContent),
                });
                $(button).text('수정');
                $(button).next().text("삭제");
            } catch (error) {
                alert(error);
            }
        }
    }
    
    getCommentList();
</script>
</body>
</html>